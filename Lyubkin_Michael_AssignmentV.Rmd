---
title: "__Solutions for Assignment V: GitHub and the ticketmaster.com API__"
author: "__DS400 Data Science Project Management WS 20/21__"
date: "February 13, 2021"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
I worked together with Lana Kern (Student ID: 5395819), Martin Scheerer
(Student ID: 5631373) and Anton Höhl (Student ID: 5637078). I hereby assure that
my submission is in line with the *Code of Conduct* outlined on the lecture slides.

### __General Setup__

First I use ``opts_knit$set(root.dir = "")`` from the ``knitr`` package to set a 
working directory that will not cause problems in RMarkdown. Secondly, I clear my
workspace and load ( if needed) the relevant R packages that I need for the assignment.

```{r general_setup}
rm(list = ls())  # clear workspace

# Setting my working directory in RMarkdown with the knitr package, instead of setwd() to not get any type of inconsistencies.

knitr::opts_knit$set(root.dir = "C:/Users/Lenovo/Desktop/Uni/Data Science Project Management/Assignments/Assignment5/DSPM_Assignment")

# Install relevant packages if needed

if (!require("tidyverse")) install.packages("tidyverse")
if (!require("httr")) install.packages("httr")
if (!require("rlist")) install.packages("rlist")
if (!require("jsonlite")) install.packages("jsonlite")
if (!require("maps")) install.packages("maps")

# Load the respective packages

library(tidyverse)
library(httr)
library(rlist)
library(jsonlite)
library(maps)

```

## __Exercise 1: Setting up a new GitHub repository__

All the necessary 

The project's repository can be found on Github under the following Link:
https://github.com/michaellyubkin/DSPM_Assignment


## __Exercise 2: Getting to know the API__

```{r source_API_key}
source("API_key.R")

```


## __Exercise 3: Interacting with the API - the basics__

```{r API_requests_first_page}
response <- GET("https://app.ticketmaster.com/discovery/v2/venues.json?",
                  query=list(apikey=API_key,
                             countryCode="DE",
                             locale="*"))

status_code(response)

json <- jsonlite::fromJSON(content(x=response, as = "text"))

venues <- json$`_embedded`$venues

venues_data <- 0

venues_data$name <- venues$name
venues_data$city <- venues$city$name
venues_data$postalCode <- venues$postalCode
venues_data$address <- venues$address$line1
venues_data$url <- venues$url
venues_data$longitude <- as.double(venues$location$longitude)
venues_data$latitude <- as.double(venues$location$latitude)

venues_data <- as.data.frame(venues_data)

venues_data <- venues_data[,-1]

glimpse(venues_data)

```

## __Exercise 4: Interacting with the API - advanced__

```{r all_pages}
n <- as.numeric(json[['page']][['totalElements']])
pages <- floor(n/500)

remainder <- n-500*floor(n/500)

size_500 <- 500

all_venues <- data.frame()

pages <- pages + 1

for (i in 0:pages) {
  res_venues <- GET("https://app.ticketmaster.com/discovery/v2/venues.json?", 
                    query = list(apikey = API_key,
                                 countryCode = "DE",
                                 locale="*",
                                 page   = i,
                                 size=size_500))
  
  json_all <- jsonlite::fromJSON(content(x=res_venues, as = "text"))
  
  venues_all <- json_all$`_embedded`$venues
  
  venues_data_all <- tibble(
    name= character(length(venues_all$name)),
    city=character(length(venues_all$name)),
    postalCode=character(length(venues_all$name)),
    address=character(length(venues_all$name)),
    url=character(length(venues_all$name)),
    longitude=character(length(venues_all$name)),
    latitude=character(length(venues_all$name)))
  
  venues_data_all$name <- venues_all$name
  venues_data_all$city <- venues_all$city$name
  venues_data_all$postalCode <- venues_all$postalCode
  venues_data_all$address <- venues_all$address$line1
  venues_data_all$url <- venues_all$url
  venues_data_all$longitude <- as.double(venues_all$location$longitude)
  venues_data_all$latitude <- as.double(venues_all$location$latitude)   

  
  all_venues <- rbind(all_venues, venues_data_all)
  
  
  Sys.sleep(2)
}
```


## __Exercise 5: Visualizing the extracted data__

```{r preparing_for_map}

map_data_venues <- all_venues

map_data_venues$long <- ifelse(between(map_data_venues$longitude, 5.866944, 15.043611), 
                          map_data_venues$longitude, NA)

map_data_venues$lat <- ifelse(between(map_data_venues$latitude, 47.271679, 55.0846), 
                          map_data_venues$latitude, NA)

sum(is.na(map_data_venues$long))
sum(is.na(map_data_venues$lat))

```


```{r map}

ggplot() + 
  geom_polygon(
        aes(x = long, y = lat, group = group), 
        data = map_data("world", region = "Germany"),
        fill = "grey90",color = "black") +
  theme_void() + 
  coord_quickmap() +
  geom_point(data = map_data_venues, aes(x = long, y = lat), size = 0.5) +
  labs(title = "Event locations across Germany", 
       caption = "Source: ticketmaster.com") + 
  theme(title = element_text(size=8, face='bold'),
        plot.caption = element_text(face = "italic"))


```

## __Exercise 6: Event locations in other countries__

```{r exercise_3}

response <- GET("https://app.ticketmaster.com/discovery/v2/venues.json?",
                  query=list(apikey=API_key,
                             countryCode="CZ",
                             locale="*"))

status_code(response)

json <- jsonlite::fromJSON(content(x=response, as = "text"))

venues <- json$`_embedded`$venues

venues_data <- 0

venues_data$name <- venues$name
venues_data$city <- venues$city$name
venues_data$postalCode <- venues$postalCode
venues_data$address <- venues$address$line1
venues_data$url <- venues$url
venues_data$longitude <- as.double(venues$location$longitude)
venues_data$latitude <- as.double(venues$location$latitude)

venues_data <- as.data.frame(venues_data)

venues_data <- venues_data[,-1]

glimpse(venues_data)

venues_data$longitude[venues_data$longitude==0] <- NA
venues_data$latitude[venues_data$latitude==0] <- NA

```

```{r exercise_4}

n <- as.numeric(json[['page']][['totalElements']])
pages <- floor(n/500)

remainder <- n-500*floor(n/500)

size_500 <- 500

all_venues <- data.frame()

pages <- pages + 1

for (i in 0:pages) {
  res_venues <- GET("https://app.ticketmaster.com/discovery/v2/venues.json?", 
                    query = list(apikey = API_key,
                                 countryCode = "CZ",
                                 locale="*",
                                 page   = i,
                                 size=size_500))
  
  json_all <- jsonlite::fromJSON(content(x=res_venues, as = "text"))
  
  venues_all <- json_all$`_embedded`$venues
  
  venues_data_all <- tibble(
    name= character(length(venues_all$name)),
    city=character(length(venues_all$name)),
    postalCode=character(length(venues_all$name)),
    address=character(length(venues_all$name)),
    url=character(length(venues_all$name)),
    longitude=character(length(venues_all$name)),
    latitude=character(length(venues_all$name)))
  
  venues_data_all$name <- venues_all$name
  venues_data_all$city <- venues_all$city$name
  venues_data_all$postalCode <- venues_all$postalCode
  venues_data_all$address <- venues_all$address$line1
  venues_data_all$url <- venues_all$url
  venues_data_all$longitude <- as.double(venues_all$location$longitude)
  venues_data_all$latitude <- as.double(venues_all$location$latitude)   

  
  all_venues <- rbind(all_venues, venues_data_all)
  
  
  Sys.sleep(2)
}

```

```{r preparing_data_map}

map_data_venues <- all_venues

map_data_venues$longitude[map_data_venues$longitude==0] <- NA
map_data_venues$latitude[map_data_venues$latitude==0] <- NA

map_data_venues <- map_data_venues %>%
  filter(name !="TEST Venue Product Support" & name !="Divadlo Na Orlí")

sum(is.na(map_data_venues$long))
sum(is.na(map_data_venues$lat))


```

```{r map_sweden}
ggplot() + 
  geom_polygon(
        aes(x = long, y = lat, group = group), 
        data = map_data("world", region = "Czech Republic"),
        fill = "grey90",color = "black") +
  theme_void() + 
  coord_quickmap() +
  geom_point(data = map_data_venues, aes(x = longitude, y = latitude), size = 0.5) +
  labs(title = "Event locations across Czech Republic", 
       caption = "Source: ticketmaster.com") + 
  theme(title = element_text(size=8, face='bold'),
        plot.caption = element_text(face = "italic"))


```