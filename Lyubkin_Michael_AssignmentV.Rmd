---
title: "__Solutions for Assignment V: GitHub and the ticketmaster.com API__"
author: "__DS400 Data Science Project Management WS 20/21__"
date: "February 13, 2021"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
I worked together with Lana Kern (Student ID: 5395819), Martin Scheerer
(Student ID: 5631373) and Anton HÃ¶hl (Student ID: 5637078). I hereby assure that
my submission is in line with the *Code of Conduct* outlined on the lecture slides.

### __General Setup__

irst I use ``opts_knit$set(root.dir = "")`` from the ``knitr`` package to set a 
working directory that will not cause problems in RMarkdown. Secondly, I clear my
workspace and load ( if needed) the relevant R packages that I need for the assignment.

```{r general_setup}
rm(list = ls())  # clear workspace

# Setting my working directory in RMarkdown with the knitr package, instead of setwd() to not get any type of inconsistencies.

knitr::opts_knit$set(root.dir = "C:/Users/Lenovo/Desktop/Uni/Data Science Project Management/Assignments/Assignment5/DSPM_Assignment")

# Install relevant packages if needed

if (!require("tidyverse")) install.packages("tidyverse")
if (!require("httr")) install.packages("httr")
if (!require("rlist")) install.packages("rlist")
if (!require("jsonlite")) install.packages("jsonlite")
if (!require("maps")) install.packages("maps")

# Load the respective packages

library(tidyverse)
library(httr)
library(rlist)
library(jsonlite)
library(maps)

```

## __Exercise 2: Getting to know the API__

```{r source_API_key}
source("API_key.R")

```


## __Exercise 3: Interacting with the API - the basics__

```{r API_requests_first_page}
response <- GET("https://app.ticketmaster.com/discovery/v2/venues.json?",
                  query=list(apikey=API_key,
                             countryCode="DE",
                             locale="*"))

status_code(response)

json <- jsonlite::fromJSON(content(x=response, as = "text"))

venues <- json$`_embedded`$venues

venues_data <- 0

venues_data$name <- venues$name
venues_data$city <- venues$city$name
venues_data$postalCode <- venues$postalCode
venues_data$address <- venues$address$line1
venues_data$url <- venues$url
venues_data$longitude <- as.double(venues$location$longitude)
venues_data$latitude <- as.double(venues$location$latitude)

venues_data <- as.data.frame(venues_data)

venues_data <- venues_data[,-1]

glimpse(venues_data)

```

## __Exercise 4: Interacting with the API - advanced__

```{r all_pages}
n <- as.numeric(json[['page']][['totalElements']])
pages <- floor(n/500)

remainder <- n-500*floor(n/500)

size_500 <- 500

all_venues <- data.frame()


for (i in 0:25) {
  res_venues <- GET("https://app.ticketmaster.com/discovery/v2/venues.json?", 
                    query = list(apikey = API_key,
                                 countryCode = "DE",
                                 locale="*",
                                 page   = i,
                                 size=size_500))
  
  json_all <- jsonlite::fromJSON(content(x=res_venues, as = "text"))
  
  venues_all <- json_all$`_embedded`$venues
  
  venues_data_all <- tibble(
    name= character(length(venues_all$name)),
    city=character(length(venues_all$name)),
    postalCode=character(length(venues_all$name)),
    address=character(length(venues_all$name)),
    url=character(length(venues_all$name)),
    longitude=character(length(venues_all$name)),
    latitude=character(length(venues_all$name)))
  
  venues_data_all$name <- venues_all$name
  venues_data_all$city <- venues_all$city$name
  venues_data_all$postalCode <- venues_all$postalCode
  venues_data_all$address <- venues_all$address$line1
  venues_data_all$url <- venues_all$url
  venues_data_all$longitude <- as.double(venues_all$location$longitude)
  venues_data_all$latitude <- as.double(venues_all$location$latitude)   

  
  all_venues <- rbind(all_venues, venues_data_all)
  
  
  Sys.sleep(2)
}
```


